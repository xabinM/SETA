services:
  # 기존 Spark Streaming (메시지 필터링)
  spark:
    build: 
      context: .
      dockerfile: Dockerfile
    image: pyspark-tiktoken-app
    container_name: spark-streaming-dev
    ports:
      - "8888:8888"
      - "4040:4040"
    volumes:
      - .:/home/jovyan/work
    environment:
      - SPARK_OPTS=--driver-java-options=-Xms1g --driver-java-options=-Xmx4g --driver-java-options=-Dlog4j.logLevel=info
      # 서버1 Kafka 연결로 변경
      - KAFKA_BOOTSTRAP_SERVERS=172.26.14.94:9092
      # 서버1 메인 PostgreSQL 연결
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    networks:
      - app-network

  # 배치 처리용 Spark (토큰 사용량 집계)
  spark-batch:
    image: bitnami/spark:3.5
    container_name: spark-batch-processor
    volumes:
      - ./spark_batch_aggregation.py:/opt/bitnami/spark/app/spark_batch_aggregation.py
    environment:
      # 서버1 메인 PostgreSQL 연결
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    command: /bin/bash -c "
      echo 'Waiting for dependencies...' &&
      sleep 30 &&
      echo 'Starting token usage aggregation...' &&
      /opt/bitnami/spark/bin/spark-submit 
      --master local[*] 
      --packages org.postgresql:postgresql:42.7.3 
      /opt/bitnami/spark/app/spark_batch_aggregation.py"
    networks:
      - app-network
    restart: unless-stopped

networks:
  app-network:
    driver: bridge