stages:
  - build
  - build-docker
  - deploy

variables:
  BACKEND_IMAGE: $DOCKER_REGISTRY/$DOCKER_USERNAME/backend:$CI_COMMIT_SHORT_SHA
  DOCKER_TLS_CERTDIR: ""                         # DIND 사용 시 TLS 비활성화
  SSH_KNOWN_HOSTS: $SSH_KNOWN_HOSTS
  SSH_PRIVATE_KEY: $SSH_PRIVATE_KEY

# ----------------
# 1. Backend Build (Java + Gradle)
# ----------------
backend-build:
  stage: build
  image: amazoncorretto:17
  script:
    - cd Backend
    - chmod +x gradlew
    - ./gradlew clean bootJar
  artifacts:
    paths:
      - Backend/build/libs/*.jar
    expire_in: 1 hour
  only:
    - Devops_config

# ----------------
# 2. Build Docker Image & Push to Registry
# ----------------
backend-build-docker:
  stage: build-docker
  image: docker:20.10.16
  services:
    - name: docker:20.10.16-dind   # Docker-in-Docker 사용
      alias: docker
      command: ["--host=tcp://0.0.0.0:2375"]  # TLS 없이 접근 가능
  variables:
    DOCKER_TLS_CERTDIR: ""          # DIND TLS 비활성화
    DOCKER_HOST: tcp://docker:2375 # Docker daemon 주소 지정
  before_script:
    - docker info                   # Docker daemon 연결 확인
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin $DOCKER_REGISTRY
  script:
    - docker build -t $BACKEND_IMAGE ./Backend
    - docker push $BACKEND_IMAGE
  dependencies:
    - backend-build
  only:
    - Devops_config

# ----------------
# 3. Deploy to Server via SSH
# ----------------
deploy-to-server-a:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client bash rsync
    - mkdir -p ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - eval "$(ssh-agent -s)"
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
  script:
    # SCP 대신 rsync 사용 (더 안정적)
    - rsync -avz -e "ssh -o LogLevel=ERROR -o StrictHostKeyChecking=no" Devops/deploy.sh $DEPLOY_USER@$DEPLOY_SERVER_A:/home/$DEPLOY_USER/
    - rsync -avz -e "ssh -o LogLevel=ERROR -o StrictHostKeyChecking=no" Devops/docker-compose.server-a.yml $DEPLOY_USER@$DEPLOY_SERVER_A:/home/$DEPLOY_USER/

    # .env 파일 생성
    - |
      ssh -o LogLevel=ERROR $DEPLOY_USER@$DEPLOY_SERVER_A "cat > /home/${DEPLOY_USER}/.env <<EOF
      DB_USER=${DB_USER}
      DB_PASSWORD=${DB_PASSWORD}
      DB_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      DB_NAME=${DB_NAME}
      JWT_SECRET=${JWT_SECRET}
      JWT_ACCESSTOKENEXPIRATIONMS=${JWT_ACCESSTOKENEXPIRATIONMS}
      JWT_REFRESHTOKENEXPIRATIONMS=${JWT_REFRESHTOKENEXPIRATIONMS}
      REDIS_HOST=${REDIS_HOST}
      REDIS_PORT=${REDIS_PORT}
      EOF"

    # 배포 스크립트 실행 (구문 오류 수정)
    - ssh -o LogLevel=ERROR $DEPLOY_USER@$DEPLOY_SERVER_A "cd /home/${DEPLOY_USER} && chmod +x deploy.sh && ./deploy.sh '${BACKEND_IMAGE}'"
  only:
    - Devops_config
