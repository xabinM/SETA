stages:
  - build
  - build-docker
  - deploy

variables:
  DOCKER_REGISTRY: $CI_REGISTRY                  # GitLab Container Registry
  BACKEND_IMAGE: $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA
  DOCKER_TLS_CERTDIR: ""                         # DIND 사용 시 TLS 비활성화
  SSH_KNOWN_HOSTS: $SSH_KNOWN_HOSTS
  SSH_PRIVATE_KEY: $SSH_PRIVATE_KEY

# ----------------
# 1. Backend Build (Java + Gradle)
# ----------------
backend-build:
  stage: build
  image: amazoncorretto:17
  script:
    - cd Backend
    - chmod +x gradlew
    - ./gradlew clean bootJar
  artifacts:
    paths:
      - Backend/build/libs/*.jar
    expire_in: 1 hour
  only:
    - Devops_config

# ----------------
# 2. Build Docker Image & Push to Registry
# ----------------
backend-build-docker:
  stage: build-docker
  image: docker:20.10.16
  services:
    - docker:dind                     # Docker-in-Docker 사용
  variables:
    DOCKER_TLS_CERTDIR: ""            # DIND TLS 비활성화
  before_script:
    - docker info                      # Docker daemon 연결 확인
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $DOCKER_REGISTRY
  script:
    - docker build -t $BACKEND_IMAGE ./Backend
    - docker push $BACKEND_IMAGE
  dependencies:
    - backend-build
  only:
    - Devops_config

# ----------------
# 3. Deploy to Server via SSH
# ----------------
deploy-to-server-a:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client bash rsync  # SSH 접속 및 파일 복사용
    - mkdir -p ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - eval "$(ssh-agent -s)"
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
  script:
    # 배포 스크립트와 docker-compose 파일 복사
    - scp Devops/deploy.sh $DEPLOY_SERVER_A:/home/$DEPLOY_USER/deploy.sh
    - scp Devops/docker-compose.server-a.yml $DEPLOY_SERVER_A:/home/$DEPLOY_USER/docker-compose.server-a.yml

    # 원격 서버에 .env 생성
    - ssh $DEPLOY_SERVER_A "echo 'DB_USER=${DB_USER}' > /home/${DEPLOY_USER}/.env"
    - ssh $DEPLOY_SERVER_A "echo 'DB_PASSWORD=${DB_PASSWORD}' >> /home/${DEPLOY_USER}/.env"
    - ssh $DEPLOY_SERVER_A "echo 'DB_NAME=${DB_NAME}' >> /home/${DEPLOY_USER}/.env"
    - ssh $DEPLOY_SERVER_A "echo 'JWT_SECRET=${JWT_SECRET}' >> /home/${DEPLOY_USER}/.env"
    - ssh $DEPLOY_SERVER_A "echo 'JWT_ACCESSTOKENEXPIRATIONMS=${JWT_ACCESSTOKENEXPIRATIONMS}' >> /home/${DEPLOY_USER}/.env"
    - ssh $DEPLOY_SERVER_A "echo 'JWT_REFRESHTOKENEXPIRATIONMS=${JWT_REFRESHTOKENEXPIRATIONMS}' >> /home/${DEPLOY_USER}/.env"

    # 배포 스크립트 실행
    - ssh $DEPLOY_SERVER_A "cd /home/${DEPLOY_USER} && chmod +x deploy.sh && ./deploy.sh $BACKEND_IMAGE"
  only:
    - Devops_config
