stages:
  - build
  - build-docker
  - deploy

variables:
  BACKEND_IMAGE: $DOCKER_REGISTRY/$DOCKER_USERNAME/backend:$CI_COMMIT_SHORT_SHA
  FRONTEND_IMAGE: $DOCKER_REGISTRY/$DOCKER_USERNAME/frontend:$CI_COMMIT_SHORT_SHA
  DOCKER_TLS_CERTDIR: ""                         # DIND 사용 시 TLS 비활성화
  SSH_KNOWN_HOSTS: $SSH_KNOWN_HOSTS
  SSH_PRIVATE_KEY: $SSH_PRIVATE_KEY
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"   # Gradle 캐시를 프로젝트 내부에 저장

# ----------------
# 1. Backend Build (Java + Gradle)
# ----------------
backend-build:
  stage: build
  image: amazoncorretto:17
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .gradle/caches/
      - .gradle/wrapper/
      - .gradle/wrapper/dists/
      - Backend/.gradle
  script:
    - cd Backend
    - chmod +x gradlew
    - ./gradlew clean bootJar
  artifacts:
    paths:
      - Backend/build/libs/*.jar
    expire_in: 1 hour
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(master|Devops_main|Devops_config|Back_main)$/'
      when: always
    - when: never

# ----------------
# 2. Frontend Build (React + Node)
# ----------------
frontend-build:
  stage: build
  image: node:18-alpine
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - Frontend/seta-front/node_modules/
  script:
    - cd Frontend/seta-front
    - npm ci
    - npm run build
  artifacts:
    paths:
      - Frontend/seta-front/dist
    expire_in: 1 hour
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(master|Devops_main|Devops_config|Front_main)$/'
      when: always
    - when: never

# ----------------
# 3. Backend Docker Image & Push to Registry.
# ----------------
backend-build-docker:
  stage: build-docker
  image: docker:25
  services:
    - name: docker:dind   # Docker-in-Docker 사용
      alias: docker
      command: ["--host=tcp://0.0.0.0:2375"]  # TLS 없이 접근 가능
  variables:
    DOCKER_TLS_CERTDIR: ""          # DIND TLS 비활성화
    DOCKER_HOST: tcp://docker:2375 # Docker daemon 주소 지정
  before_script:
    - docker info                   # Docker daemon 연결 확인
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin $DOCKER_REGISTRY
  script:
    - docker build -t $BACKEND_IMAGE ./Backend
    - docker push $BACKEND_IMAGE
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(master|Devops_main|Devops_config|Back_main)$/'
      when: always
    - when: never
  dependencies:
    - backend-build

# ----------------
# 4. Frontend Docker Image Build & Push
# ----------------
frontend-build-docker:
  stage: build-docker
  image: docker:25
  services:
    - name: docker:dind
      alias: docker
      command: ["--host=tcp://0.0.0.0:2375"]
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: tcp://docker:2375
  before_script:
    - docker info
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin $DOCKER_REGISTRY
  script:
    - docker build -t $FRONTEND_IMAGE ./Frontend/seta-front
    - docker push $FRONTEND_IMAGE
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(master|Devops_main|Devops_config|Front_main)$/'
      when: always
    - when: never
  dependencies:
    - frontend-build

# ----------------
# 5. Deploy backend
# ----------------
deploy-backend:
  stage: deploy
  image: alpine:latest
  needs:
    - job: backend-build-docker
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(master|Devops_main|Devops_config|Back_main)$/'
      when: always
    - when: never
  before_script:
    - apk add --no-cache openssh-client bash rsync
    - mkdir -p ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - eval "$(ssh-agent -s)"
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
  script:
    # 파일 전송
    - rsync -avz -e "ssh -o LogLevel=ERROR -o StrictHostKeyChecking=no" Devops/deploy-backend.sh $DEPLOY_USER@$DEPLOY_SERVER_A:/home/$DEPLOY_USER/
    - rsync -avz -e "ssh -o LogLevel=ERROR -o StrictHostKeyChecking=no" Devops/docker-compose.backend.yml $DEPLOY_USER@$DEPLOY_SERVER_A:/home/$DEPLOY_USER/

    # .env 파일 생성 (모든 Backend 환경변수 포함)
    - |
      ssh -o LogLevel=ERROR $DEPLOY_USER@$DEPLOY_SERVER_A "cat > /home/${DEPLOY_USER}/.env <<EOF
      DB_USER=${DB_USER}
      DB_PASSWORD=${DB_PASSWORD}
      DB_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      DB_NAME=${DB_NAME}

      SPRING_REDIS_HOST=${REDIS_HOST}
      SPRING_REDIS_PORT=${REDIS_PORT}

      JWT_SECRET=${JWT_SECRET}
      JWT_ACCESSTOKENEXPIRATIONMS=${JWT_ACCESSTOKENEXPIRATIONMS}
      JWT_REFRESHTOKENEXPIRATIONMS=${JWT_REFRESHTOKENEXPIRATIONMS}

      SPRING_KAFKA_BOOTSTRAP_SERVERS=${SPRING_KAFKA_BOOTSTRAP_SERVERS}

      BACKEND_IMAGE=${BACKEND_IMAGE}

      GMS_OPENAI_API_KEY=${GMS_OPENAI_API_KEY}
      GMS_OPENAI_BASE_URL=${GMS_OPENAI_BASE_URL}
      GMS_OPENAI_COMPLETIONS_PATH=${GMS_OPENAI_COMPLETIONS_PATH}
      GMS_OPENAI_MODEL=${GMS_OPENAI_MODEL}
      GMS_OPENAI_TIMEOUT_MS=${GMS_OPENAI_TIMEOUT_MS}
      EOF"
      
      # 파일 실행
    - ssh -o LogLevel=ERROR $DEPLOY_USER@$DEPLOY_SERVER_A "cd /home/${DEPLOY_USER} && chmod +x deploy-backend.sh && ./deploy-backend.sh '${DEPLOY_USER}'"

# ----------------
# 6. Deploy frontend
# ----------------
deploy-frontend:
  stage: deploy
  image: alpine:latest
  needs:
    - job: frontend-build-docker
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(master|Devops_main|Devops_config|Front_main)$/'
      when: always
    - when: never
  before_script:
    - apk add --no-cache openssh-client bash rsync
    - mkdir -p ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - eval "$(ssh-agent -s)"
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
  script:
      # 파일 전송
    - rsync -avz -e "ssh -o LogLevel=ERROR -o StrictHostKeyChecking=no" Devops/deploy-frontend.sh $DEPLOY_USER@$DEPLOY_SERVER_A:/home/$DEPLOY_USER/
    - rsync -avz -e "ssh -o LogLevel=ERROR -o StrictHostKeyChecking=no" Devops/docker-compose.frontend.yml $DEPLOY_USER@$DEPLOY_SERVER_A:/home/$DEPLOY_USER/

      # 파일 실행
    - ssh -o LogLevel=ERROR $DEPLOY_USER@$DEPLOY_SERVER_A "cd /home/${DEPLOY_USER} && chmod +x deploy-frontend.sh && ./deploy-frontend.sh '${FRONTEND_IMAGE}' '${DEPLOY_USER}'"
